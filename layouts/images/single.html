{{ define "main" }}
<article class="post image-post">
  <h1 class="post-title">
    <a href="{{ .Permalink }}">{{ .Title | markdownify }}</a>
  </h1>
  <div class="post-meta">
    {{- with .Params.Author -}}
      <span class="post-author">{{ . }}</span>
    {{- end -}}
    {{- if .Date -}}
      <time class="post-date">
        {{- .Date.Format "01/02/2006" -}}
        {{- if $.Site.Params.showLastUpdated -}}
          [{{- or $.Site.Params.updatedDatePrefix "Updated" -}} :: {{- .Lastmod.Format "01/02/2006" -}}]
        {{- end -}}
      </time>
    {{- end -}}
  </div>

  {{ if .Params.tags }}
    <span class="post-tags">
      {{ range .Params.tags }}
      #<a href="{{ (urls.JoinPath "tags" (urlize .) "/") | absLangURL }}">{{ . }}</a>&nbsp;
      {{ end }}
    </span>
  {{ end }}

  <div class="image-container">
    {{ if .Params.image }}
      <figure class="image-figure">
        {{ $image := resources.Get .Params.image }}
        {{ if $image }}
          <img src="{{ $image.RelPermalink }}" alt="{{ .Params.imageAlt | default .Title }}" class="featured-image lightbox-trigger" onclick="openLightbox(this)">
        {{ else }}
          <img src="{{ .Params.image | absURL }}" alt="{{ .Params.imageAlt | default .Title }}" class="featured-image lightbox-trigger" onclick="openLightbox(this)">
        {{ end }}
        {{ if .Params.imageCaption }}
          <figcaption class="image-caption">{{ .Params.imageCaption | markdownify }}</figcaption>
        {{ end }}
      </figure>
    {{ end }}
  </div>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close">&times;</span>
    <img class="lightbox-content" id="lightbox-img">
    <div class="lightbox-caption" id="lightbox-caption"></div>
  </div>

  <div class="post-content">
    {{- with .Content -}}
      <div>
        {{ . | replaceRE "(<h[1-9] id=\"([^\"]+)\".+)(</h[1-9]+>)" `${1}<a href="#${2}" class="hanchor" ariaLabel="Anchor">&#8983;</a> ${3}` | safeHTML }}
      </div>
    {{- end -}}
  </div>

  {{- if ne (.Param "callout") false -}}
  {{ partial "callout.html" }}
  {{- end -}}
  {{ if not (.Params.hideComments | default false) }}
    {{ partial "comments.html" . }}
  {{ end }}
</article>

<script>
function openLightbox(img) {
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-img');
  const lightboxCaption = document.getElementById('lightbox-caption');
  
  lightbox.style.display = 'block';
  lightboxImg.src = img.src;
  lightboxImg.alt = img.alt;
  
  // Get caption from the figcaption element
  const figcaption = img.parentElement.querySelector('.image-caption');
  if (figcaption) {
    lightboxCaption.innerHTML = figcaption.innerHTML;
    lightboxCaption.style.display = 'block';
  } else {
    lightboxCaption.style.display = 'none';
  }
  
  // Prevent body scroll when lightbox is open
  document.body.style.overflow = 'hidden';
}

function closeLightbox() {
  const lightbox = document.getElementById('lightbox');
  lightbox.style.display = 'none';
  
  // Restore body scroll
  document.body.style.overflow = 'auto';
}

// Close lightbox with Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeLightbox();
  }
});

// Prevent lightbox from closing when clicking on the image
document.getElementById('lightbox-img').addEventListener('click', function(event) {
  event.stopPropagation();
});
</script>
{{ end }}