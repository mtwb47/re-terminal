{{- $allPages := slice -}}
{{- range site.RegularPages -}}
  {{- if or (in site.Params.mainSections .Type) (eq .Type "links") (eq .Type "images") -}}
    {{- $allPages = $allPages | append . -}}
  {{- end -}}
{{- end -}}
{{- $postsByYear := dict -}}

{{- range $allPages -}}
  {{- $year := .Date.Format "2006" -}}
  {{- $yearPosts := index $postsByYear $year | default slice -}}
  {{- $postsByYear = merge $postsByYear (dict $year ($yearPosts | append .)) -}}
{{- end -}}

{{- $years := slice -}}
{{- range $year, $posts := $postsByYear -}}
  {{- $years = $years | append $year -}}
{{- end -}}
{{- $years = sort $years "value" "desc" -}}
{{- $currentYear := now.Format "2006" -}}

<div class="archives">
  {{- range $year := $years -}}
    {{- $yearPosts := index $postsByYear $year -}}
    <details class="year-section"{{ if eq $year $currentYear }} open{{ end }}>
      <summary>{{ $year }} ({{ len $yearPosts }} posts)</summary>
      <div class="content">
        <ul class="post-list">
          {{- range $yearPosts -}}
            <li class="{{ if eq .Type "links" }}link-post{{ else if eq .Type "images" }}image-post{{ end }}">
              <span class="post-date">{{ .Date.Format "Jan 2" }}</span>
              <a href="{{ .Permalink }}" class="post-link">
                {{- if eq .Type "links" -}}
                  ðŸ”— {{ .Title }}
                {{- else if eq .Type "images" -}}
                  ðŸ“· {{ .Title }}
                {{- else -}}
                  {{ .Title }}
                {{- end -}}
              </a>
            </li>
          {{- end -}}
        </ul>
      </div>
    </details>
  {{- end -}}
</div>